<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SCORD</title>
<style>
  :root{
    --bg:#071020;
    --panel:#0b1220;
    --muted:#9aa4b2;
    --accent:#5865F2; /* blurple-like accent */
    --accent-2:#4752c4;
    --danger:#ff6b6b;
    --card:#0e1622;
    --glass: rgba(255,255,255,0.03);
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{background:linear-gradient(180deg,#05101a 0%,var(--bg) 100%);color:#e6eef6;display:flex;align-items:stretch}
  .app{display:grid;grid-template-columns:240px 1fr 320px;height:100vh;width:100%;gap:12px;padding:12px;box-sizing:border-box}
  .panel{background:linear-gradient(180deg,var(--glass),rgba(255,255,255,0.01));border-radius:10px;padding:12px;box-sizing:border-box;overflow:auto;backdrop-filter: blur(6px)}
  .sidebar{display:flex;flex-direction:column;gap:8px}
  .server-head{display:flex;align-items:center;gap:8px}
  .server-dot{width:36px;height:36px;background:linear-gradient(135deg,var(--accent),var(--accent-2));border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700}
  .brand{display:flex;flex-direction:column}
  .brand .name{font-weight:700;font-size:16px}
  .brand .tag{font-size:12px;color:var(--muted)}
  .channels{margin-top:8px;display:flex;flex-direction:column;gap:6px}
  .channel{padding:8px;border-radius:6px;cursor:pointer;color:var(--muted);display:flex;justify-content:space-between}
  .channel.active{background:rgba(88,101,242,0.12);color:#fff}
  .main{display:flex;flex-direction:column;height:100%}
  .messages{flex:1;overflow:auto;padding:12px;display:flex;flex-direction:column;gap:10px}
  .message{display:flex;gap:8px;align-items:flex-start}
  .avatar{width:40px;height:40px;border-radius:8px;background:#152233;display:flex;align-items:center;justify-content:center;color:var(--muted);font-weight:700}
  .msg-body{background:rgba(255,255,255,0.02);padding:8px 10px;border-radius:8px}
  .msg-meta{font-size:12px;color:var(--muted)}
  .composer{display:flex;gap:8px;padding:10px;border-top:1px solid rgba(255,255,255,0.02)}
  .input{flex:1;border-radius:8px;padding:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
  .btn{background:linear-gradient(180deg,var(--accent),var(--accent-2));border:none;color:white;padding:8px 12px;border-radius:8px;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.03)}
  .right{display:flex;flex-direction:column;gap:8px}
  .userinfo{display:flex;gap:8px;align-items:center}
  .small{font-size:12px;color:var(--muted)}
  .connect-row{display:flex;gap:8px;margin-bottom:8px}
  .danger{background:var(--danger)}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:#12202a;padding:10px 14px;border-radius:8px;color:var(--muted)}
  .admin-badge{font-size:11px;color:#fff;background:#444;padding:2px 6px;border-radius:6px;margin-left:6px}
  /* Admin panel modal - pro style */
  .modal-backdrop{position:fixed;inset:0;background:linear-gradient(rgba(2,6,23,0.6),rgba(2,6,23,0.6));display:flex;align-items:center;justify-content:center;z-index:1000}
  .modal{width:960px;max-width:98%;background:linear-gradient(180deg,#071020,#091122);border-radius:12px;padding:14px;box-shadow:0 20px 60px rgba(6,8,20,0.8);color:#e6eef6;max-height:90vh;overflow:auto;border:1px solid rgba(88,101,242,0.12)}
  .admin-grid{display:grid;grid-template-columns:430px 1fr;gap:14px}
  .panel-card{background:var(--card);border-radius:8px;padding:10px;border:1px solid rgba(255,255,255,0.02)}
  .admin-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .admin-left{display:flex;flex-direction:column;gap:8px}
  .admin-rows{display:flex;flex-direction:column;gap:6px}
  .msg-row{display:flex;gap:8px;align-items:flex-start;padding:8px;border-radius:6px;border-bottom:1px solid rgba(255,255,255,0.02)}
  .msg-row:hover{background:linear-gradient(90deg,rgba(88,101,242,0.02),transparent)}
  .msg-row.selected{background:linear-gradient(90deg,rgba(88,101,242,0.08),transparent);box-shadow:inset 0 0 0 1px rgba(88,101,242,0.06)}
  .checkbox{margin-right:8px}
  .admin-controls{display:flex;gap:8px;flex-wrap:wrap}
  .small-muted{font-size:11px;color:#9aa4b2}
  .thin{font-weight:300}
  .right .section{margin-bottom:12px}
  .user-row{display:flex;justify-content:space-between;align-items:center;padding:6px;border-radius:6px}
  .muted-note{font-size:11px;color:#a3a3a3}
  @media(max-width:900px){.app{grid-template-columns:1fr} .right{display:none} .modal{width:95%}}
</style>
</head>
<body>
<div class="app">
  <div class="panel sidebar">
    <div class="server-head">
      <div class="server-dot">S</div>
      <div class="brand">
        <div class="name">SCORD</div>
        <div class="tag small">chat • community</div>
      </div>
    </div>

    <div style="margin-top:8px">
      <div class="small">Server</div>
      <div class="connect-row">
        <input id="serverUrl" class="input" placeholder="wss://yourserver.example" value="" />
        <button id="connectBtn" class="btn">Connect</button>
      </div>
      <div class="small">Display name</div>
      <input id="nameInput" class="input" placeholder="Your name" />
      <div class="small" style="margin-top:6px">Admin password (optional)</div>
      <input id="adminPassword" class="input" placeholder="admin password (if any)" type="password" />
    </div>

    <div class="channels">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div class="small">Channels</div>
        <button id="newChannel" class="btn ghost" style="padding:6px;border-radius:6px">+</button>
      </div>
      <div id="channelsList"></div>
    </div>
  </div>

  <div class="panel main">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div>
        <div id="channelTitle" style="font-weight:700">#general</div>
        <div class="small" id="channelSub">Welcome to SCORD</div>
      </div>
      <div class="small" id="status">Disconnected</div>
    </div>

    <div id="messages" class="messages" aria-live="polite"></div>

    <div class="composer">
      <input id="messageInput" class="input" placeholder="Message #channel" />
      <button id="sendBtn" class="btn">Send</button>
      <button id="leaveBtn" class="btn danger" title="Disconnect">Leave</button>
    </div>
  </div>

  <div class="panel right">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="small">Users</div>
      <div id="adminPanelToggleHolder"></div>
    </div>
    <div id="usersList" aria-live="polite"></div>
    <hr style="border:0;border-top:1px solid rgba(255,255,255,0.02)" />
    <div class="small">Settings</div>
    <label class="small" style="margin-top:6px">Persist name</label>
    <input type="checkbox" id="persistName" checked />
    <div class="small" style="margin-top:10px">Tip: open this file directly in the browser or host on GitHub Pages. Set Server to your deployed server URL.</div>
  </div>
</div>

<div id="toast" class="toast" style="display:none" role="status" aria-live="polite"></div>

<!-- Admin Modal (hidden by default) -->
<div id="adminModal" style="display:none" aria-hidden="true"></div>

<script>
(function(){
  // UI elements
  const serverUrlEl = document.getElementById('serverUrl');
  const connectBtn = document.getElementById('connectBtn');
  const nameInput = document.getElementById('nameInput');
  const adminPasswordInput = document.getElementById('adminPassword');
  const persistName = document.getElementById('persistName');
  const newChannelBtn = document.getElementById('newChannel');
  const channelsList = document.getElementById('channelsList');
  const channelTitle = document.getElementById('channelTitle');
  const channelSub = document.getElementById('channelSub');
  const messagesEl = document.getElementById('messages');
  const usersList = document.getElementById('usersList');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const leaveBtn = document.getElementById('leaveBtn');
  const statusEl = document.getElementById('status');
  const toast = document.getElementById('toast');
  const adminModalRoot = document.getElementById('adminModal');
  const adminPanelToggleHolder = document.getElementById('adminPanelToggleHolder');

  // state
  let ws = null;
  let clientId = null;
  let currentChannel = 'general';
  let channels = ['general'];
  let users = [];
  let serverUrl = '';
  let amIAdmin = false;
  let currentHistory = [];
  const storageKeyName = 'scord_name';
  const storageKeyServer = 'scord_server';

  // restore name/server
  try {
    const savedName = localStorage.getItem(storageKeyName);
    if (savedName) nameInput.value = savedName;
    const savedServer = localStorage.getItem(storageKeyServer);
    if (savedServer) serverUrlEl.value = savedServer;
  } catch(e){}

  function showToast(text, ms=3500){
    toast.textContent = text;
    toast.style.display = 'block';
    setTimeout(()=> toast.style.display='none', ms);
  }

  function setStatus(s){
    statusEl.textContent = s;
  }

  function renderChannels(){
    channelsList.innerHTML = '';
    channels.forEach(ch=>{
      const el = document.createElement('div');
      el.className = 'channel' + (ch===currentChannel?' active':'');
      el.textContent = '#'+ch;
      el.onclick = ()=> joinChannel(ch);
      channelsList.appendChild(el);
    });
  }

  function renderUsers(){
    usersList.innerHTML = '';
    users.forEach(u=>{
      const el = document.createElement('div');
      el.style.display='flex'; el.style.justifyContent='space-between'; el.style.padding='6px 4px';
      const left = document.createElement('div');
      left.textContent = u.name;
      if (u.isAdmin) {
        const badge = document.createElement('span'); badge.className='admin-badge'; badge.textContent='admin';
        left.appendChild(badge);
      }
      const rightWrap = document.createElement('div');
      rightWrap.style.display='flex'; rightWrap.style.gap='6px'; rightWrap.style.alignItems='center';
      const rightText = document.createElement('div');
      rightText.className='small';
      rightText.textContent = u.channel || '';
      rightWrap.appendChild(rightText);

      // admin controls if I'm admin and not targeting myself
      if (amIAdmin && u.id !== clientId) {
        const kickBtn = document.createElement('button'); kickBtn.textContent='Kick'; kickBtn.className='btn';
        kickBtn.style.padding='4px 6px'; kickBtn.onclick = ()=> {
          if (confirm('Kick '+u.name+'?')) sendAdminAction('kick', { targetId: u.id });
        };
        const banBtn = document.createElement('button'); banBtn.textContent='Ban'; banBtn.className='btn ghost';
        banBtn.style.padding='4px 6px'; banBtn.onclick = ()=> {
          if (confirm('Ban '+u.name+'?')) sendAdminAction('ban', { targetName: u.name });
        };
        const ipBtn = document.createElement('button'); ipBtn.textContent='IP Ban'; ipBtn.className='btn ghost';
        ipBtn.style.padding='4px 6px'; ipBtn.onclick = ()=> {
          if (!u.ip) return showToast('No IP available for that user (server may hide it).');
          if (confirm('IP ban '+u.ip+' (user '+u.name+')?')) sendAdminAction('ip_ban', { ip: u.ip });
        };
        rightWrap.appendChild(kickBtn); rightWrap.appendChild(banBtn); rightWrap.appendChild(ipBtn);
      }

      el.appendChild(left); el.appendChild(rightWrap);
      usersList.appendChild(el);
    });
  }

  function addMessage(m){
    const row = document.createElement('div');
    row.className = 'message';
    if (m.id) row.dataset.messageId = m.id;
    const avatar = document.createElement('div');
    avatar.className='avatar';
    avatar.textContent = (m.from || '?')[0] || '?';
    const body = document.createElement('div');
    const meta = document.createElement('div');
    meta.className = 'msg-meta';
    meta.textContent = (m.from || 'system') + (m.time ? ' • ' + new Date(m.time).toLocaleTimeString() : '') + (m.viaAdmin ? ' • via admin' : '');
    const text = document.createElement('div');
    text.className='msg-body';
    text.textContent = m.text || '';
    body.appendChild(meta); body.appendChild(text);
    row.appendChild(avatar); row.appendChild(body);
    messagesEl.appendChild(row);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function clearMessages(){
    messagesEl.innerHTML = '';
  }

  // Ensure admin password popup on connect when name is localadmin.
  function ensureAdminPasswordPrompt() {
    try {
      if (getName() === 'localadmin') {
        const pw = window.prompt('Enter admin password for localadmin (leave blank to connect without admin):', '');
        if (pw !== null && pw.length > 0) {
          adminPasswordInput.value = pw;
        } else {
          adminPasswordInput.value = '';
        }
      }
    } catch (e) {}
  }

  function joinChannel(ch){
    currentChannel = ch;
    channelTitle.textContent = '#'+ch;
    channelSub.textContent = 'Channel: '+ch;
    renderChannels();
    clearMessages();
    if (ws && ws.readyState === WebSocket.OPEN) {
      const payload = { type: 'join', name: getName(), channel: ch };
      const pwd = adminPasswordInput.value;
      if (pwd) payload.adminPassword = pwd;
      ws.send(JSON.stringify(payload));
    }
  }

  function getName(){ return nameInput.value.trim() || 'Anonymous'; }

  connectBtn.addEventListener('click', ()=>{
    if (ws) { showToast('Already connected'); return; }
    serverUrl = serverUrlEl.value.trim();
    if (!serverUrl) return showToast('Enter server URL (wss://...)');

    try { localStorage.setItem(storageKeyServer, serverUrl); } catch(e){}

    ensureAdminPasswordPrompt();
    connect(serverUrl);
  });

  leaveBtn.addEventListener('click', ()=>{
    if (ws) ws.close();
  });

  newChannelBtn.addEventListener('click', ()=>{
    const name = prompt('New channel name (no #)');
    if (name) {
      channels = Array.from(new Set([...channels, name]));
      renderChannels();
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'create_channel', channel: name }));
        joinChannel(name);
      } else {
        joinChannel(name);
      }
    }
  });

  sendBtn.addEventListener('click', sendMessage);
  messageInput.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') sendMessage(); });

  nameInput.addEventListener('change', ()=>{
    if (persistName.checked) {
      try { localStorage.setItem(storageKeyName, nameInput.value); } catch(e){}
    }
  });

  function sendMessage(){
    const txt = messageInput.value.trim();
    if (!txt) return;
    const payload = { type: 'message', text: txt, channel: currentChannel };
    if (ws && ws.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify(payload));
      messageInput.value = '';
    } else {
      addMessage({ from: getName(), text: txt, time: Date.now() });
      messageInput.value = '';
    }
  }

  function sendAdminAction(action, opts = {}) {
    if (!ws || ws.readyState !== WebSocket.OPEN) return showToast('Not connected');
    ws.send(JSON.stringify(Object.assign({ type: 'admin', action }, opts)));
  }

  // Admin modal rendering with pro-style layout (reworked)
  function renderAdminPanel() {
    adminModalRoot.innerHTML = '';
    const backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop';
    const modal = document.createElement('div');
    modal.className = 'modal';
    const header = document.createElement('div');
    header.className = 'admin-header';
    const title = document.createElement('div');
    title.innerHTML = '<strong>Moderation Panel</strong><div class="small-muted thin">manage messages, users and config</div>';
    const closeBtn = document.createElement('button'); closeBtn.className='btn'; closeBtn.textContent='Close';
    closeBtn.onclick = () => { adminModalRoot.style.display = 'none'; };
    header.appendChild(title); header.appendChild(closeBtn);
    modal.appendChild(header);

    const grid = document.createElement('div'); grid.className = 'admin-grid';

    // Left column: messages with select all
    const left = document.createElement('div'); left.className='panel-card';
    const leftTop = document.createElement('div'); leftTop.style.display='flex'; leftTop.style.justifyContent='space-between'; leftTop.style.alignItems='center';
    const leftTitle = document.createElement('div'); leftTitle.innerHTML = '<strong>Messages</strong><div class="small-muted">current channel</div>';
    const leftCtrls = document.createElement('div');
    const selectAll = document.createElement('input'); selectAll.type='checkbox'; selectAll.title='Select all';
    selectAll.onchange = (ev) => {
      const boxes = document.querySelectorAll('#adminMsgs input[type=checkbox]');
      boxes.forEach(b => b.checked = selectAll.checked);
      document.querySelectorAll('#adminMsgs .msg-row').forEach((r,i)=> {
        if (selectAll.checked) r.classList.add('selected'); else r.classList.remove('selected');
      });
    };
    const reloadBtn = document.createElement('button'); reloadBtn.className='btn ghost'; reloadBtn.textContent='Reload'; reloadBtn.onclick = loadHistory;
    const deleteSelBtn = document.createElement('button'); deleteSelBtn.className='btn'; deleteSelBtn.textContent='Delete selected'; deleteSelBtn.onclick = deleteSelectedMessages;
    leftCtrls.appendChild(selectAll); leftCtrls.appendChild(reloadBtn); leftCtrls.appendChild(deleteSelBtn);
    leftTop.appendChild(leftTitle); leftTop.appendChild(leftCtrls);
    left.appendChild(leftTop);
    const msgsContainer = document.createElement('div'); msgsContainer.id='adminMsgs'; msgsContainer.style.marginTop='10px'; msgsContainer.style.maxHeight='62vh'; msgsContainer.style.overflow='auto';
    left.appendChild(msgsContainer);

    // Right column: users / impersonate / config
    const right = document.createElement('div'); right.className='panel-card';
    // Users
    const usersTitle = document.createElement('div'); usersTitle.innerHTML = '<strong>Users</strong>';
    right.appendChild(usersTitle);
    const usersArea = document.createElement('div'); usersArea.id='adminUsers'; usersArea.style.marginBottom='10px'; right.appendChild(usersArea);

    // impersonate
    const impBox = document.createElement('div'); impBox.className='section';
    impBox.innerHTML = '<div class="small-muted">Send a message as another user</div>';
    const asNameInput = document.createElement('input'); asNameInput.placeholder='username'; asNameInput.className='input';
    const asTextInput = document.createElement('input'); asTextInput.placeholder='message text'; asTextInput.className='input';
    const asChanInput = document.createElement('input'); asChanInput.placeholder='channel (optional)'; asChanInput.className='input';
    const impBtn = document.createElement('button'); impBtn.className='btn'; impBtn.textContent='Send';
    impBtn.onclick = () => {
      if (!asNameInput.value || !asTextInput.value) return showToast('asName and text required');
      sendAdminAction('impersonate', { asName: asNameInput.value, text: asTextInput.value, channel: asChanInput.value || currentChannel });
      showToast('Impersonation sent');
    };
    impBox.appendChild(asNameInput); impBox.appendChild(asTextInput); impBox.appendChild(asChanInput); impBox.appendChild(impBtn);
    right.appendChild(impBox);

    // config
    const cfgBox = document.createElement('div'); cfgBox.className='section';
    cfgBox.innerHTML = '<div class="small-muted">Server config</div>';
    const familyLabel = document.createElement('label'); familyLabel.className='small'; familyLabel.style.display='block';
    const familyCheckbox = document.createElement('input'); familyCheckbox.type='checkbox'; familyCheckbox.style.marginRight='8px';
    familyLabel.appendChild(familyCheckbox); familyLabel.appendChild(document.createTextNode('Family friendly mode'));
    const profanityArea = document.createElement('textarea'); profanityArea.className='input'; profanityArea.style.height='110px'; profanityArea.style.width='100%';
    profanityArea.placeholder = 'One profane word per line';
    const saveCfgBtn = document.createElement('button'); saveCfgBtn.className='btn'; saveCfgBtn.textContent='Save';
    saveCfgBtn.onclick = () => {
      const prof = profanityArea.value.split('\n').map(s=>s.trim()).filter(Boolean);
      sendAdminAction('set_config', { config: { familyFriendly: !!familyCheckbox.checked, profanity: prof } });
      showToast('Config save requested');
    };
    cfgBox.appendChild(familyLabel); cfgBox.appendChild(profanityArea); cfgBox.appendChild(saveCfgBtn);
    right.appendChild(cfgBox);

    grid.appendChild(left);
    grid.appendChild(right);
    modal.appendChild(grid);
    backdrop.appendChild(modal);
    adminModalRoot.appendChild(backdrop);
    adminModalRoot.style.display = 'block';
    adminModalRoot.setAttribute('aria-hidden', 'false');

    // helpers: populate messages and users
    function renderAdminMessages() {
      const c = document.getElementById('adminMsgs');
      c.innerHTML = '';
      currentHistory.forEach(m => {
        const row = document.createElement('div'); row.className = 'msg-row';
        row.dataset.messageId = m.id;
        const cb = document.createElement('input'); cb.type = 'checkbox'; cb.className='checkbox'; cb.dataset.messageId = m.id;
        cb.onchange = () => { row.classList.toggle('selected', cb.checked); };
        const meta = document.createElement('div'); meta.style.flex='1';
        const metaTitle = document.createElement('div'); metaTitle.className='small-muted'; metaTitle.textContent = `${m.from} • ${new Date(m.time).toLocaleString()} • ${m.id}`;
        const metaText = document.createElement('div'); metaText.textContent = m.text;
        meta.appendChild(metaTitle); meta.appendChild(metaText);
        row.appendChild(cb); row.appendChild(meta);
        c.appendChild(row);
      });
    }

    function renderAdminUsers() {
      const a = document.getElementById('adminUsers');
      a.innerHTML = '';
      users.forEach(u => {
        const row = document.createElement('div'); row.className='user-row';
        const left = document.createElement('div'); left.textContent = `${u.name} ${u.ip ? '('+u.ip+')' : ''}`;
        const right = document.createElement('div'); right.style.display='flex'; right.style.gap='6px';
        const kick = document.createElement('button'); kick.className='btn'; kick.textContent='Kick'; kick.onclick = () => { if (confirm('Kick '+u.name+'?')) sendAdminAction('kick', { targetId: u.id }); };
        const ban = document.createElement('button'); ban.className='btn ghost'; ban.textContent='Ban'; ban.onclick = () => { if (confirm('Ban '+u.name+'?')) sendAdminAction('ban', { targetName: u.name }); };
        const ipban = document.createElement('button'); ipban.className='btn ghost'; ipban.textContent='IP Ban'; ipban.onclick = () => { if (!u.ip) return showToast('No IP'); if (confirm('IP ban '+u.ip+'?')) sendAdminAction('ip_ban', { ip: u.ip }); };
        right.appendChild(kick); right.appendChild(ban); right.appendChild(ipban);
        row.appendChild(left); row.appendChild(right);
        a.appendChild(row);
      });
    }

    // load history (from server REST) and config
    function loadHistory() {
      fetch('/messages/' + encodeURIComponent(currentChannel)).then(r => r.json()).then(js => {
        currentHistory = js.messages || [];
        renderAdminMessages();
      }).catch(e => showToast('History load failed'));
    }
    function loadConfig() {
      fetch('/config').then(r => r.json()).then(js => {
        if (js && js.config) {
          familyCheckbox.checked = !!js.config.familyFriendly;
          profanityArea.value = (js.config.profanity || []).join('\n');
        }
      }).catch(e => {});
    }

    loadHistory();
    renderAdminUsers();
    loadConfig();
  }

  // delete selected messages: collect checked boxes within adminMsgs
  function deleteSelectedMessages() {
    const checks = Array.from(document.querySelectorAll('#adminMsgs input[type=checkbox]:checked'));
    if (!checks.length) return showToast('No messages selected');
    const ids = checks.map(c => c.dataset.messageId).filter(Boolean);
    if (!ids.length) return showToast('No message ids found');
    if (!confirm('Delete ' + ids.length + ' messages?')) return;
    sendAdminAction('delete_messages', { messageIds: ids });
    // optimistic remove from UI
    ids.forEach(id => {
      const el = document.querySelector('#adminMsgs .msg-row[data-message-id="' + id + '"]');
      if (el) el.remove();
      // also remove from main messages view if present
      const mainEl = document.querySelector('[data-message-id="' + id + '"]');
      if (mainEl) mainEl.remove();
    });
    showToast('Delete requested');
  }

  // create admin panel toggle button (shown if amIAdmin)
  function updateAdminToggle() {
    adminPanelToggleHolder.innerHTML = '';
    if (amIAdmin) {
      const btn = document.createElement('button'); btn.className='btn'; btn.textContent='Admin Panel';
      btn.onclick = renderAdminPanel;
      adminPanelToggleHolder.appendChild(btn);
    }
  }

  function connect(url){
    try {
      setStatus('Connecting...');
      ws = new WebSocket(url);
      ws.addEventListener('open', ()=>{
        setStatus('Connected');
        const payload = { type: 'join', name: getName(), channel: currentChannel };
        const pwd = adminPasswordInput.value;
        if (pwd) payload.adminPassword = pwd;
        ws.send(JSON.stringify(payload));
        showToast('Connected');
      });
      ws.addEventListener('message', ev=>{
        try {
          const msg = JSON.parse(ev.data);
          handleServerMessage(msg);
        } catch(e){
          console.warn('Bad msg', ev.data);
        }
      });
      ws.addEventListener('close', ()=>{
        setStatus('Disconnected');
        ws = null;
        amIAdmin = false;
        updateAdminToggle();
        showToast('Disconnected from server');
      });
      ws.addEventListener('error', (e)=>{
        setStatus('Error');
        console.error(e);
        showToast('Connection error');
      });
    } catch(e){
      setStatus('Failed');
      showToast('Connect failed: '+e.message);
    }
  }

  function handleServerMessage(msg){
    switch(msg.type){
      case 'joined':
        clientId = msg.clientId;
        users = msg.users || [];
        channels = msg.channels || channels;
        const me = (msg.users || []).find(u => u.id === clientId);
        amIAdmin = !!(me && me.isAdmin);
        renderChannels();
        renderUsers();
        updateAdminToggle();
        addMessage({ from: 'system', text: 'You joined as ' + getName(), time: Date.now() });
        break;
      case 'history':
        if (msg.channel === currentChannel && Array.isArray(msg.messages)) {
          currentHistory = msg.messages;
          clearMessages();
          msg.messages.forEach(m => addMessage(m));
        }
        break;
      case 'userlist':
        users = msg.users || [];
        const me2 = users.find(u => u.id === clientId);
        amIAdmin = !!(me2 && me2.isAdmin);
        renderUsers();
        updateAdminToggle();
        break;
      case 'channels':
        channels = msg.channels || channels;
        renderChannels();
        break;
      case 'message':
        if (!msg.channel || msg.channel === currentChannel) {
          addMessage(msg);
        }
        break;
      case 'delete_message':
        if (!msg.messageId) break;
        const el = document.querySelector('[data-message-id="' + msg.messageId + '"]');
        if (el) el.remove();
        addMessage({ from: 'system', text: `Message ${msg.messageId} deleted`, time: Date.now() });
        break;
      case 'config_updated':
        showToast('Server config updated');
        break;
      case 'admin_action_result':
        showToast('Admin action ' + msg.action + ' result: ' + (msg.ok ? 'ok' : 'fail'));
        break;
      case 'error':
        showToast('Server error: ' + (msg.message || ''));
        break;
      default:
        console.log('unknown', msg);
    }
  }

  // initial load
  joinChannel(currentChannel);

})();
</script>
</body>
</html>
